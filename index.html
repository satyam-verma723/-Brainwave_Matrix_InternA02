<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InkWell - Your Personal Blog (Local Storage Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.12/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose img {
            max-width: 100%;
            border-radius: 0.5rem;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- App Container -->
    <div id="app" class="max-w-6xl mx-auto px-4 py-8">

        <!-- Header -->
        <header class="flex justify-between items-center pb-6 border-b-2 border-gray-100 mb-8">
            <a href="#" class="text-3xl font-bold text-gray-900 tracking-tight" id="home-link">InkWell (Local)</a>
            <div id="auth-links" class="flex items-center space-x-4">
                <!-- Auth links will be dynamically inserted here -->
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Dynamic content will be rendered here -->
        </main>

    </div>

    <!-- Auth Modal -->
    <div id="auth-modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="auth-modal" class="modal w-full max-w-md bg-white rounded-lg shadow-xl p-8 hidden">
        <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-center"></h2>
        <form id="auth-form">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <p id="auth-error" class="text-red-500 text-sm mb-4 text-center"></p>
            <div>
                <button type="submit" id="auth-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"></button>
            </div>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
            <span id="auth-switch-prompt"></span>
            <a href="#" id="auth-switch-link" class="font-medium text-indigo-600 hover:text-indigo-500"></a>
        </p>
         <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="confirm-modal" class="modal w-full max-w-sm bg-white rounded-lg shadow-xl p-6 hidden">
        <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900 mb-4">Are you sure?</h3>
        <p id="confirm-modal-text" class="text-sm text-gray-600 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
            <button id="confirm-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <!-- App Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UI Elements ---
        const mainContent = document.getElementById('main-content');
        const authLinks = document.getElementById('auth-links');
        const homeLink = document.getElementById('home-link');
        const authModal = document.getElementById('auth-modal');
        const authModalBackdrop = document.getElementById('auth-modal-backdrop');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authSwitchPrompt = document.getElementById('auth-switch-prompt');
        const authSwitchLink = document.getElementById('auth-switch-link');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const notification = document.getElementById('notification');
        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');

        // --- App State & Data ---
        let currentUser = null;
        let users = [];
        let posts = [];

        const loadData = () => {
            users = JSON.parse(localStorage.getItem('inkwell_users')) || [];
            posts = JSON.parse(localStorage.getItem('inkwell_posts')) || [];
            currentUser = JSON.parse(sessionStorage.getItem('inkwell_currentUser')) || null;
        };

        const saveData = () => {
            localStorage.setItem('inkwell_users', JSON.stringify(users));
            localStorage.setItem('inkwell_posts', JSON.stringify(posts));
            if (currentUser) {
                sessionStorage.setItem('inkwell_currentUser', JSON.stringify(currentUser));
            } else {
                sessionStorage.removeItem('inkwell_currentUser');
            }
        };
        
        // --- UTILITY FUNCTIONS ---
        const showNotification = (message, isError = false) => {
            notification.textContent = message;
            notification.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        };

        const formatDate = (isoDate) => {
            if (!isoDate) return 'Just now';
            return new Date(isoDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        const showConfirmModal = (text) => {
            return new Promise((resolve) => {
                confirmModalText.textContent = text;
                const handleConfirm = () => { closeConfirmModal(); resolve(true); };
                const handleCancel = () => { closeConfirmModal(); resolve(false); };

                const closeConfirmModal = () => {
                    confirmModal.classList.add('hidden');
                    confirmModalBackdrop.classList.add('hidden');
                    confirmModalConfirmBtn.removeEventListener('click', handleConfirm);
                    confirmModalCancelBtn.removeEventListener('click', handleCancel);
                    confirmModalBackdrop.removeEventListener('click', handleCancel);
                };

                confirmModalConfirmBtn.addEventListener('click', handleConfirm);
                confirmModalCancelBtn.addEventListener('click', handleCancel);
                confirmModalBackdrop.addEventListener('click', handleCancel);
                confirmModal.classList.remove('hidden');
                confirmModalBackdrop.classList.remove('hidden');
            });
        };

        // --- AUTHENTICATION ---
        const updateUIForAuthState = () => {
            authLinks.innerHTML = '';
            if (currentUser) {
                const welcomeEl = document.createElement('span');
                welcomeEl.className = 'text-sm text-gray-600';
                const userName = currentUser.email.split('@')[0];
                welcomeEl.textContent = `Welcome, ${userName}`;

                const createPostBtn = document.createElement('a');
                createPostBtn.href = '#/new';
                createPostBtn.textContent = 'Create Post';
                createPostBtn.className = 'bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700';

                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Logout';
                logoutBtn.className = 'text-sm text-gray-600 hover:text-gray-900';
                logoutBtn.onclick = logOut;
                authLinks.append(welcomeEl, createPostBtn, logoutBtn);
            } else {
                 const loginBtn = document.createElement('button');
                loginBtn.textContent = 'Login';
                loginBtn.className = 'text-sm font-medium text-gray-600 hover:text-gray-900';
                loginBtn.onclick = () => openAuthModal('login');

                const signupBtn = document.createElement('button');
                signupBtn.textContent = 'Sign Up';
                signupBtn.className = 'ml-4 bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-700';
                signupBtn.onclick = () => openAuthModal('signup');

                authLinks.append(loginBtn, signupBtn);
            }
        };

        const logOut = () => {
            currentUser = null;
            saveData();
            showNotification("You've been logged out.");
            window.location.hash = '';
            updateUIForAuthState();
            router();
        };

        const openAuthModal = (mode) => {
            authForm.dataset.mode = mode;
            authError.textContent = '';
            emailInput.value = '';
            passwordInput.value = '';
            if (mode === 'login') {
                authModalTitle.textContent = 'Login to your Account';
                authSubmitBtn.textContent = 'Login';
                authSwitchPrompt.textContent = "Don't have an account? ";
                authSwitchLink.textContent = 'Sign Up';
                authSwitchLink.onclick = () => openAuthModal('signup');
            } else {
                authModalTitle.textContent = 'Create a New Account';
                authSubmitBtn.textContent = 'Sign Up';
                authSwitchPrompt.textContent = 'Already have an account? ';
                authSwitchLink.textContent = 'Login';
                authSwitchLink.onclick = () => openAuthModal('login');
            }
            authModal.classList.remove('hidden');
            authModalBackdrop.classList.remove('hidden');
        };

        const closeAuthModal = () => {
            authModal.classList.add('hidden');
            authModalBackdrop.classList.add('hidden');
        };

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mode = authForm.dataset.mode;
            const email = emailInput.value;
            const password = passwordInput.value;
            authError.textContent = '';

            if (mode === 'login') {
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    currentUser = { id: user.id, email: user.email };
                    saveData();
                    showNotification('Login successful!');
                    closeAuthModal();
                    updateUIForAuthState();
                    router();
                } else {
                    authError.textContent = "Invalid email or password.";
                }
            } else { // signup
                if (users.some(u => u.email === email)) {
                    authError.textContent = "An account with this email already exists.";
                    return;
                }
                const newUser = { id: Date.now().toString(), email, password };
                users.push(newUser);
                currentUser = { id: newUser.id, email: newUser.email };
                saveData();
                showNotification('Account created successfully!');
                closeAuthModal();
                updateUIForAuthState();
                router();
            }
        });
        
        closeModalBtn.addEventListener('click', closeAuthModal);
        authModalBackdrop.addEventListener('click', closeAuthModal);

        // --- RENDERING FUNCTIONS ---
        const renderLoading = () => {
            mainContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
        };
        
        const renderHomePage = () => {
            if (posts.length === 0) {
                mainContent.innerHTML = `<div class="text-center py-16"><h2 class="text-2xl font-semibold mb-2">No posts yet.</h2><p class="text-gray-600">Why not create the first one?</p></div>`;
                return;
            }
            
            let postsHtml = '<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">';
            // Sort posts by creation date, newest first
            [...posts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(post => {
                const snippet = marked.parse(post.content).replace(/<[^>]*>/g, '').substring(0, 100) + '...';
                postsHtml += `
                    <a href="#/post/${post.id}" class="block bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2 text-gray-900">${post.title}</h3>
                            <p class="text-gray-600 text-sm mb-4">${snippet}</p>
                            <div class="text-xs text-gray-500">
                                <span>By ${post.authorEmail.split('@')[0]}</span> &bull; <span>${formatDate(post.createdAt)}</span>
                            </div>
                        </div>
                    </a>
                `;
            });
            postsHtml += '</div>';
            mainContent.innerHTML = postsHtml;
        };

        const renderPostPage = (postId) => {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                mainContent.innerHTML = `<p class="text-center text-red-500">Post not found.</p>`;
                return;
            }

            const isAuthor = currentUser && currentUser.id === post.authorId;
            let postHtml = `
                <article class="max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                    <h1 class="text-4xl font-extrabold text-gray-900 mb-4">${post.title}</h1>
                    <div class="text-sm text-gray-500 mb-6">
                        <span>By ${post.authorEmail}</span> &bull; <span>${formatDate(post.createdAt)}</span>
                    </div>
                    <div class="prose lg:prose-xl max-w-none mb-8">${marked.parse(post.content)}</div>
                    ${isAuthor ? `
                        <div class="flex space-x-4 border-t pt-4">
                            <a href="#/edit/${post.id}" class="text-indigo-600 hover:text-indigo-800">Edit</a>
                            <button id="delete-post-btn" class="text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    ` : ''}
                </article>
                <section id="comments-section" class="max-w-3xl mx-auto mt-12">
                    <h2 class="text-2xl font-bold mb-6">Comments</h2>
                    ${currentUser ? `
                        <form id="comment-form" class="mb-8">
                            <textarea id="comment-text" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="Write a comment..." required></textarea>
                            <button type="submit" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Post Comment</button>
                        </form>
                    ` : '<p class="text-gray-600 mb-8"><a href="#" id="login-to-comment" class="text-indigo-600 font-semibold">Log in</a> to post a comment.</p>'}
                    <div id="comments-list"></div>
                </section>
            `;
            mainContent.innerHTML = postHtml;
            
            if (isAuthor) {
                document.getElementById('delete-post-btn').addEventListener('click', () => deletePost(post.id));
            }
            if (currentUser) {
                 document.getElementById('comment-form').addEventListener('submit', (e) => { e.preventDefault(); addComment(post.id); });
            } else {
                document.getElementById('login-to-comment').onclick = (e) => { e.preventDefault(); openAuthModal('login'); };
            }
            renderComments(post);
        };
        
        const renderComments = (post) => {
            const commentsList = document.getElementById('comments-list');
            if (!post.comments || post.comments.length === 0) {
                commentsList.innerHTML = `<p class="text-gray-500">No comments yet.</p>`;
                return;
            }
            
            let commentsHtml = '<div class="space-y-6">';
            [...post.comments].sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(comment => {
                commentsHtml += `
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-gray-800">${comment.text}</p>
                        <p class="text-xs text-gray-500 mt-2">
                            By ${comment.authorEmail.split('@')[0]} on ${formatDate(comment.createdAt)}
                        </p>
                    </div>
                `;
            });
            commentsHtml += '</div>';
            commentsList.innerHTML = commentsHtml;
        };

        const renderPostForm = (postId = null) => {
            if (!currentUser) {
                showNotification("You must be logged in to create or edit posts.", true);
                window.location.hash = '';
                router();
                return;
            }

            let post = { title: '', content: ''};
            let pageTitle = 'Create a New Post';
            if (postId) {
                pageTitle = 'Edit Your Post';
                const foundPost = posts.find(p => p.id === postId);
                if (foundPost) {
                    if (foundPost.authorId !== currentUser.id) {
                        showNotification("You are not authorized to edit this post.", true);
                        window.location.hash = '';
                        router();
                        return;
                    }
                    post = foundPost;
                }
            }

            mainContent.innerHTML = `
                <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-3xl font-bold mb-6">${pageTitle}</h2>
                    <form id="post-form">
                        <div class="mb-4">
                            <label for="post-title" class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="post-title" value="${post.title}" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="mb-6">
                            <label for="post-content" class="block text-sm font-medium text-gray-700">Content (Markdown supported)</label>
                            <textarea id="post-content" rows="10" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">${post.content}</textarea>
                        </div>
                        <div>
                             <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                ${postId ? 'Update Post' : 'Publish Post'}
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('post-form').addEventListener('submit', (e) => {
                e.preventDefault();
                savePost(postId);
            });
        };
        
        // --- DATA CRUD OPERATIONS ---
        const savePost = (postId) => {
            const title = document.getElementById('post-title').value;
            const content = document.getElementById('post-content').value;

            if (!title.trim() || !content.trim()) {
                showNotification("Title and content cannot be empty.", true);
                return;
            }

            if (postId) { // Update existing post
                const postIndex = posts.findIndex(p => p.id === postId);
                if (postIndex > -1) {
                    posts[postIndex].title = title;
                    posts[postIndex].content = content;
                    showNotification('Post updated successfully!');
                    window.location.hash = `#/post/${postId}`;
                }
            } else { // Create new post
                const newPost = {
                    id: Date.now().toString(),
                    title,
                    content,
                    authorId: currentUser.id,
                    authorEmail: currentUser.email,
                    createdAt: new Date().toISOString(),
                    comments: []
                };
                posts.push(newPost);
                showNotification('Post published successfully!');
                window.location.hash = `#/post/${newPost.id}`;
            }
            saveData();
            router();
        };

        const deletePost = async (postId) => {
            const confirmed = await showConfirmModal('Are you sure you want to delete this post? This action cannot be undone.');
            if (confirmed) {
                posts = posts.filter(p => p.id !== postId);
                saveData();
                showNotification('Post deleted.');
                window.location.hash = '';
                router();
            }
        };
        
        const addComment = (postId) => {
            const commentTextEl = document.getElementById('comment-text');
            const text = commentTextEl.value;

            if (!text.trim()) {
                showNotification("Comment cannot be empty.", true);
                return;
            }
            
            const post = posts.find(p => p.id === postId);
            if(post) {
                const newComment = {
                    id: Date.now().toString(),
                    text,
                    authorId: currentUser.id,
                    authorEmail: currentUser.email,
                    createdAt: new Date().toISOString()
                };
                if (!post.comments) post.comments = [];
                post.comments.push(newComment);
                saveData();
                commentTextEl.value = '';
                renderComments(post);
            }
        };

        // --- ROUTER ---
        const router = () => {
            const path = window.location.hash.substring(1);
            if (path.startsWith('/post/')) {
                const postId = path.split('/')[2];
                renderPostPage(postId);
            } else if (path.startsWith('/edit/')) {
                const postId = path.split('/')[2];
                renderPostForm(postId);
            } else if (path === '/new') {
                renderPostForm();
            } else {
                renderHomePage();
            }
        };

        // --- INITIALIZATION ---
        const init = () => {
            loadData();
            updateUIForAuthState();
            router();
            window.addEventListener('hashchange', router);
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = '';
                router();
            });
        };

        init();
    });
    </script>
</body>
</html>

